Description: Build system fixes
 1. Strip -Werror and -pedantic.
 2. Fix gcrypt discovery.
 3. Explicitly discover dl.
 4. Explicitly add some more libraries.
 5. Fix LDFLAGS vs. LDADD to allow -Wl,--as-needed.
 6. Clean up linking of shared libraries.
Author: Dominik George <nik@naturalnet.de>
diff -ur a/configure.ac b/configure.ac
--- a/configure.ac	2017-07-08 21:50:19.000000000 +0200
+++ b/configure.ac	2017-08-23 15:09:43.465634392 +0200
@@ -19,7 +19,7 @@
 
 AC_PREREQ([2.61])
 AC_INIT([guacamole-server], [0.9.13-incubating])
-AM_INIT_AUTOMAKE([-Wall -Werror foreign subdir-objects])
+AM_INIT_AUTOMAKE([-Wall foreign subdir-objects])
 AM_SILENT_RULES([yes])
 
 LT_PREREQ([2.2])
@@ -63,6 +63,11 @@
               AC_DEFINE([HAVE_LIBPTHREAD],,
                         [Whether libpthread was found])])
 
+# dlopen
+LIBADD_DLOPEN=
+AC_SEARCH_LIBS([dlopen], [dl], [LIBADD_DLOPEN=$ac_cv_search_dlopen],
+               [AC_MSG_ERROR([libguac requires dlopen()])])
+
 # OSSP UUID
 AC_CHECK_LIB([ossp-uuid], [uuid_make], [UUID_LIBS=-lossp-uuid],
              AC_CHECK_LIB([uuid], [uuid_make], [UUID_LIBS=-luuid],
@@ -497,9 +502,9 @@
 
     # libfreerdp-core / libfreerdp
     AC_CHECK_LIB([freerdp-core], [freerdp_new],
-                 [RDP_LIBS="$RDP_LIBS -lfreerdp-core"],
+                 [RDP_LIBS="$RDP_LIBS -lfreerdp-core -lfreerdp-common -lfreerdp-client -lwinpr-utils"],
                  [AC_CHECK_LIB([freerdp], [freerdp_new],
-                               [RDP_LIBS="$RDP_LIBS -lfreerdp -lfreerdp-client"],
+                               [RDP_LIBS="$RDP_LIBS -lfreerdp -lfreerdp-common -lfreerdp-client -lwinpr-utils"],
                                [AC_MSG_WARN([
   --------------------------------------------
    Unable to find libfreerdp-core / libfreerdp
@@ -1036,13 +1041,14 @@
     AC_CHECK_LIB([ssh2], [gcry_control],
                          [AC_CHECK_HEADER(gcrypt.h,
                                           [AC_DEFINE([LIBSSH2_USES_GCRYPT],,
-                                                     [Whether libssh2 was built against libgcrypt])],
+                                                     [Whether libssh2 was built against libgcrypt])
+                                           SSH_LIBS="$SSH_LIBS -lgcrypt"],
                                           [AC_MSG_WARN([
   --------------------------------------------
    libssh2 appears to be built against libgcrypt, but the libgcrypt headers
    could not be found. SSH will be disabled.
   --------------------------------------------])
-                                           have_libssh2=no])])
+                                           have_libssh2=no])], [], [-lgcrypt])
 
 fi
 
diff -ur a/src/common/Makefile.am b/src/common/Makefile.am
--- a/src/common/Makefile.am	2017-04-04 06:08:12.000000000 +0200
+++ b/src/common/Makefile.am	2017-08-23 13:44:32.755154789 +0200
@@ -57,7 +57,7 @@
     surface.c
 
 libguac_common_la_CFLAGS =  \
-    -Werror -Wall -pedantic \
+    -Wall                   \
     @LIBGUAC_INCLUDE@
 
 libguac_common_la_LIBADD = \
diff -ur a/src/common-ssh/Makefile.am b/src/common-ssh/Makefile.am
--- a/src/common-ssh/Makefile.am	2017-06-11 04:00:16.000000000 +0200
+++ b/src/common-ssh/Makefile.am	2017-08-23 13:45:01.155409961 +0200
@@ -41,14 +41,12 @@
     common-ssh/user.h
 
 libguac_common_ssh_la_CFLAGS = \
-    -Werror -Wall -pedantic    \
+    -Wall                      \
     @COMMON_INCLUDE@           \
     @LIBGUAC_INCLUDE@
 
 libguac_common_ssh_la_LIBADD = \
-    @LIBGUAC_LTLIB@
-
-libguac_common_ssh_la_LDFLAGS = \
+    @LIBGUAC_LTLIB@             \
     @PTHREAD_LIBS@              \
     @SSH_LIBS@                  \
     @SSL_LIBS@
diff -ur a/src/guacd/Makefile.am b/src/guacd/Makefile.am
--- a/src/guacd/Makefile.am	2017-07-08 21:50:19.000000000 +0200
+++ b/src/guacd/Makefile.am	2017-08-23 13:45:21.067588829 +0200
@@ -47,7 +47,7 @@
     proc-map.c
 
 guacd_CFLAGS =              \
-    -Werror -Wall -pedantic \
+    -Wall                   \
     @COMMON_INCLUDE@        \
     @LIBGUACD_INCLUDE@      \
     @LIBGUAC_INCLUDE@
@@ -55,10 +55,8 @@
 guacd_LDADD =        \
     @COMMON_LTLIB@   \
     @LIBGUACD_LTLIB@ \
-    @LIBGUAC_LTLIB@
-
-guacd_LDFLAGS =    \
-    @PTHREAD_LIBS@ \
+    @LIBGUAC_LTLIB@  \
+    @PTHREAD_LIBS@   \
     @SSL_LIBS@
 
 EXTRA_DIST =         \
diff -ur a/src/libguac/Makefile.am b/src/libguac/Makefile.am
--- a/src/libguac/Makefile.am	2017-07-08 21:50:19.000000000 +0200
+++ b/src/libguac/Makefile.am	2017-08-23 14:00:47.187874261 +0200
@@ -101,10 +101,13 @@
 
 
 libguac_la_CFLAGS = \
-    -Werror -Wall -pedantic -Iguacamole
+    -Wall -Iguacamole
 
 libguac_la_LDFLAGS =     \
-    -version-info 14:0:2 \
+    -version-info 14:0:2
+
+libguac_la_LIBADD = \
+    @LIBADD_DLOPEN@      \
     @CAIRO_LIBS@         \
     @JPEG_LIBS@          \
     @PNG_LIBS@           \
@@ -112,6 +115,3 @@
     @UUID_LIBS@          \
     @VORBIS_LIBS@        \
     @WEBP_LIBS@
-
-libguac_la_LIBADD = \
-    @LIBADD_DLOPEN@ 
diff -ur a/src/libguacd/Makefile.am b/src/libguacd/Makefile.am
--- a/src/libguacd/Makefile.am	2017-07-08 21:50:19.000000000 +0200
+++ b/src/libguacd/Makefile.am	2017-08-23 13:45:35.499718449 +0200
@@ -30,16 +30,14 @@
     user.c
 
 libguacd_la_CFLAGS =        \
-    -Werror -Wall -pedantic \
+    -Wall                   \
     @COMMON_INCLUDE@        \
     @LIBGUAC_INCLUDE@
 
 libguacd_la_LIBADD = \
     @COMMON_LTLIB@   \
-    @LIBGUAC_LTLIB@
-
-libguacd_la_LDFLAGS = \
-    @PTHREAD_LIBS@    \
+    @LIBGUAC_LTLIB@  \
+    @PTHREAD_LIBS@   \
     @SSL_LIBS@
 
 # SSL support
diff -ur a/src/protocols/rdp/Makefile.am b/src/protocols/rdp/Makefile.am
--- a/src/protocols/rdp/Makefile.am	2017-06-11 04:00:16.000000000 +0200
+++ b/src/protocols/rdp/Makefile.am	2017-08-23 13:46:03.383968840 +0200
@@ -138,96 +138,100 @@
 #
 
 libguac_client_rdp_la_CFLAGS = \
-    -Werror -Wall -Iinclude    \
+    -Wall -Iinclude            \
     @COMMON_INCLUDE@           \
     @COMMON_SSH_INCLUDE@       \
     @LIBGUAC_INCLUDE@
 
 libguac_client_rdp_la_LDFLAGS = \
-    -version-info 0:0:0         \
-    @CAIRO_LIBS@                \
-    @PTHREAD_LIBS@              \
-    @RDP_LIBS@
+    -version-info 0:0:0
 
-libguac_client_rdp_la_LIBADD =     \
-    @COMMON_LTLIB@                 \
-    @LIBGUAC_LTLIB@
+libguac_client_rdp_la_LIBADD = \
+    @COMMON_LTLIB@             \
+    @LIBGUAC_LTLIB@            \   
+    @CAIRO_LIBS@               \
+    @PTHREAD_LIBS@             \
+    @RDP_LIBS@
 
 #
 # RDPDR
 #
 
 guacdr_cflags                = \
-    -Werror -Wall -Iinclude    \
+    -Wall -Iinclude            \
     @COMMON_INCLUDE@           \
     @COMMON_SSH_INCLUDE@       \
     @LIBGUAC_INCLUDE@
 
 guacdr_ldflags =                   \
-    -module -avoid-version -shared \
-    @PTHREAD_LIBS@                 \
-    @RDP_LIBS@
+    -module -avoid-version -shared
 
 guacdr_libadd =     \
     @COMMON_LTLIB@  \
-    @LIBGUAC_LTLIB@
+    @LIBGUAC_LTLIB@ \
+    @PTHREAD_LIBS@  \
+    @RDP_LIBS@      \
+    libguac-client-rdp.la
 
 #
 # Audio Input
 #
 
 guacai_cflags               =  \
-    -Werror -Wall -Iinclude    \
+    -Wall -Iinclude            \
     @COMMON_INCLUDE@           \
     @COMMON_SSH_INCLUDE@       \
     @LIBGUAC_INCLUDE@
 
 guacai_ldflags =                   \
-    -module -avoid-version -shared \
-    @PTHREAD_LIBS@                 \
-    @RDP_LIBS@
+    -module -avoid-version -shared
 
 guacai_libadd =     \
     @COMMON_LTLIB@  \
-    @LIBGUAC_LTLIB@
+    @LIBGUAC_LTLIB@ \
+    @PTHREAD_LIBS@  \
+    @RDP_LIBS@      \
+    libguac-client-rdp.la
 
 #
 # RDPSND
 #
 
 guacsnd_cflags               = \
-    -Werror -Wall -Iinclude    \
+    -Wall -Iinclude            \
     @COMMON_INCLUDE@           \
     @COMMON_SSH_INCLUDE@       \
     @LIBGUAC_INCLUDE@
 
 guacsnd_ldflags =                  \
-    -module -avoid-version -shared \
-    @PTHREAD_LIBS@                 \
-    @RDP_LIBS@
+    -module -avoid-version -shared
 
 guacsnd_libadd =    \
     @COMMON_LTLIB@  \
-    @LIBGUAC_LTLIB@
+    @LIBGUAC_LTLIB@ \
+    @PTHREAD_LIBS@  \
+    @RDP_LIBS@      \
+    libguac-client-rdp.la
 
 #
 # Static Virtual Channels
 #
 
 guacsvc_cflags               = \
-    -Werror -Wall -Iinclude    \
+    -Wall -Iinclude            \
     @COMMON_INCLUDE@           \
     @COMMON_SSH_INCLUDE@       \
     @LIBGUAC_INCLUDE@
 
 guacsvc_ldflags =                  \
-    -module -avoid-version -shared \
-    @PTHREAD_LIBS@                 \
-    @RDP_LIBS@
+    -module -avoid-version -shared
 
 guacsvc_libadd =    \
     @COMMON_LTLIB@  \
-    @LIBGUAC_LTLIB@
+    @LIBGUAC_LTLIB@ \
+    @PTHREAD_LIBS@  \
+    @RDP_LIBS@      \
+    libguac-client-rdp.la
 
 #
 # Optional SFTP support
diff -ur a/src/protocols/ssh/Makefile.am b/src/protocols/ssh/Makefile.am
--- a/src/protocols/ssh/Makefile.am	2017-06-11 04:00:16.000000000 +0200
+++ b/src/protocols/ssh/Makefile.am	2017-08-23 13:46:21.660132920 +0200
@@ -47,7 +47,7 @@
 endif
 
 libguac_client_ssh_la_CFLAGS = \
-    -Werror -Wall -Iinclude    \
+    -Wall -Iinclude            \
     @COMMON_SSH_INCLUDE@       \
     @LIBGUAC_INCLUDE@          \
     @TERMINAL_INCLUDE@
@@ -56,11 +56,11 @@
     @COMMON_LTLIB@             \
     @COMMON_SSH_LTLIB@         \
     @LIBGUAC_LTLIB@            \
-    @TERMINAL_LTLIB@
+    @TERMINAL_LTLIB@           \
+    @PTHREAD_LIBS@             \
+    @SSH_LIBS@                 \
+    @SSL_LIBS@
 
 libguac_client_ssh_la_LDFLAGS = \
-    -version-info 0:0:0         \
-    @PTHREAD_LIBS@              \
-    @SSH_LIBS@                  \
-    @SSL_LIBS@
+    -version-info 0:0:0
 
diff -ur a/src/protocols/telnet/Makefile.am b/src/protocols/telnet/Makefile.am
--- a/src/protocols/telnet/Makefile.am	2017-06-11 04:00:16.000000000 +0200
+++ b/src/protocols/telnet/Makefile.am	2017-08-23 13:46:34.360246922 +0200
@@ -39,17 +39,17 @@
     user.h
 
 libguac_client_telnet_la_CFLAGS = \
-    -Werror -Wall -Iinclude       \
+    -Wall -Iinclude               \
     @LIBGUAC_INCLUDE@             \
     @TERMINAL_INCLUDE@
 
 libguac_client_telnet_la_LIBADD = \
     @COMMON_LTLIB@                \
     @LIBGUAC_LTLIB@               \
-    @TERMINAL_LTLIB@
+    @TERMINAL_LTLIB@              \
+    @PTHREAD_LIBS@                \
+    @TELNET_LIBS@
 
 libguac_client_telnet_la_LDFLAGS = \
-    -version-info 0:0:0            \
-    @PTHREAD_LIBS@                 \
-    @TELNET_LIBS@
+    -version-info 0:0:0
 
diff -ur a/src/protocols/vnc/Makefile.am b/src/protocols/vnc/Makefile.am
--- a/src/protocols/vnc/Makefile.am	2017-06-11 04:00:16.000000000 +0200
+++ b/src/protocols/vnc/Makefile.am	2017-08-23 13:46:47.716366799 +0200
@@ -47,20 +47,20 @@
     vnc.h
 
 libguac_client_vnc_la_CFLAGS =        \
-    -Werror -Wall -pedantic -Iinclude \
+    -Wall -Iinclude                   \
     @COMMON_INCLUDE@                  \
     @COMMON_SSH_INCLUDE@              \
     @LIBGUAC_INCLUDE@                 \
     @PULSE_INCLUDE@
 
 libguac_client_vnc_la_LDFLAGS = \
-    -version-info 0:0:0         \
-    @CAIRO_LIBS@                \
-    @VNC_LIBS@ 
+    -version-info 0:0:0
 
 libguac_client_vnc_la_LIBADD = \
     @COMMON_LTLIB@             \
-    @LIBGUAC_LTLIB@
+    @LIBGUAC_LTLIB@            \
+    @CAIRO_LIBS@               \
+    @VNC_LIBS@ 
 
 # Optional SFTP support
 if ENABLE_COMMON_SSH
diff -ur a/src/pulse/Makefile.am b/src/pulse/Makefile.am
--- a/src/pulse/Makefile.am	2017-04-04 06:08:12.000000000 +0200
+++ b/src/pulse/Makefile.am	2017-08-23 13:47:00.888485011 +0200
@@ -29,12 +29,10 @@
     pulse.c
 
 libguac_pulse_la_CFLAGS =  \
-    -Werror -Wall -pedantic \
+    -Wall                  \
     @LIBGUAC_INCLUDE@
 
 libguac_pulse_la_LIBADD = \
-    @LIBGUAC_LTLIB@
-
-libguac_pulse_la_LDFLAGS = \
+    @LIBGUAC_LTLIB@       \
     @PULSE_LIBS@
 
diff -ur a/src/terminal/Makefile.am b/src/terminal/Makefile.am
--- a/src/terminal/Makefile.am	2017-06-11 05:32:44.000000000 +0200
+++ b/src/terminal/Makefile.am	2017-08-23 13:47:13.608599153 +0200
@@ -46,16 +46,14 @@
     typescript.c
 
 libguac_terminal_la_CFLAGS = \
-    -Werror -Wall            \
+    -Wall                    \
     @COMMON_INCLUDE@         \
     @LIBGUAC_INCLUDE@        \
     @PANGO_CFLAGS@           \
     @PANGOCAIRO_CFLAGS@
 
 libguac_terminal_la_LIBADD = \
-    @LIBGUAC_LTLIB@
-
-libguac_terminal_la_LDFLAGS = \
+    @LIBGUAC_LTLIB@          \
     @CAIRO_LIBS@              \
     @MATH_LIBS@               \
     @PANGO_LIBS@              \
diff -ur a/tests/Makefile.am b/tests/Makefile.am
--- a/tests/Makefile.am	2017-03-24 05:01:16.000000000 +0100
+++ b/tests/Makefile.am	2017-08-23 13:47:29.124738365 +0200
@@ -49,7 +49,7 @@
     util/guac_unicode.c
 
 test_libguac_CFLAGS =       \
-    -Werror -Wall -pedantic \
+    -Wall                   \
     @COMMON_INCLUDE@        \
     @LIBGUAC_INCLUDE@
 
